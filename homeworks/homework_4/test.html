<!DOCTYPE html>
<html>
<head>
    <title>Summary Incident Map in Lebanon</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #mapid { width: 100%; height: 670px; }

        h1 {
            text-align: center;
            color: black;
            font-size: xx-large;
        }

        h3 {
            color: black;
            font-size: x-large;
        }

        h4 {
            color: black;
            font-size: large;
        }
    </style>
</head>
<body>
    <h1>Summary of Incidents within Lebanon from 1975-1989</h1>
    <div id="mapid"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="data/smallest.js"></script>

    <script>
        var map = L.map('mapid').setView([33.8547, 35.8623], 8);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
        }).addTo(map);
 
        var desiredCountries = ["Lebanon"];
        var startDate = new Date(1975, 0, 1);
        var endDate = new Date(1989, 11, 31);
        var filteredFeatures = smallest.features.filter(function(feature) {
            var featureDate = new Date(feature.properties.Year, feature.properties.Month - 1, feature.properties.Day);
            return desiredCountries.includes(feature.properties.country_name) &&
                featureDate >= startDate && featureDate <= endDate;
        });

        var markers = L.geoJSON(null, {
            pointToLayer: function(feature, latlng) {
                var geojsonMarkerOptions = {
                    radius: 5,
                    fillColor: "#ADD8E6",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };
                var popupContent = "<b>Date:</b> " + feature.properties.Day + "/" + feature.properties.Month + "/" + feature.properties.Year + "<br>" +
                    "<b>Attack Type:</b> " + feature.properties.Attack_type + "<br>" +
                    "<b>Target:</b> " + feature.properties.Target_type + "<br>" +
                    "<b>Summary:</b> " + feature.properties.summary + "<br>" +
                    "<b>Group Name:</b> " + feature.properties.group_name;

                // Check if the marker has the same coordinates as another marker
                var key = latlng.lat + "_" + latlng.lng;
                var offsetY = 0;

                if (markersAtSameLocation[key]) {
                    offsetY = markersAtSameLocation[key] * 30; // Adjust this value as needed
                    markersAtSameLocation[key]++;
                } else {
                    markersAtSameLocation[key] = 1;
                }

                // Adjust popup position based on the number of markers at the same location
                var marker = L.circleMarker(latlng, geojsonMarkerOptions)
                    .bindPopup(popupContent, {
                        offset: [0, -offsetY] // Adjust the popup offset vertically
                    });
                return marker;
            }
        }).addTo(map);


        var markersAtSameLocation = {}; // Store markers at the same location

        filteredFeatures.forEach(function(feature) {
            if (feature.geometry && feature.geometry.coordinates) {
                var coordinates = feature.geometry.coordinates;
                var latLng = L.latLng(coordinates[1], coordinates[0]);
                markers.addData(feature);
            }
        });
    </script>
</body>
</html>
